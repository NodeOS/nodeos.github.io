---
layout: post
title:  Prebuilds, again
date:   2016-04-08T20:05:43Z
author: piranna
avatar-url: https://avatars.githubusercontent.com/u/532414?v=3&s=128
comments: 0
github-url: https://github.com/NodeOS/NodeOS/issues/224
---
In the last weeks it could seems there have been too few movement in the project due to several reasons: NodeOS core is stabilized after the [RC1](https://github.com/NodeOS/NodeOS/issues/181), and both me and other members of the project we have been busy with work and classes (I hope to read my thesis in May! :-D ). At the end, we are working on NodeOS on our spare time and we have some real-life responsabilities...

The point is that we have been banging our head against some walls while moving towards the 1.0 version. For example, @tylerl0706 has been getting some non-reproducible issues while trying to fix the pending bits to port [nodegit](http://www.nodegit.org/) so we can have a working git client on NodeOS (needed to use git repos with npm). In my case, although I got some good progresses [reimplementing nsh as a bash-languaje interpreter](https://github.com/piranna/nsh) running on a single process (that would lead in the future to write a _bash-2-javascript_ transpiler) instead of just executing the user commands, the fact is that I've [found a bug on Node.js](https://github.com/nodejs/node/issues/5574) where stdin stream is not correctly processed and makes it unusable and the alternative is to not be able to auto-detect when it's running on an interactive shell, and also trying to fix [download](https://github.com/kevva/download) module to [decompress on real time](https://github.com/kevva/download/issues/88) instead of hold the files in ram (making it impossible to download NodeOS dependencies on memory constrained systems) lead to some cryptic errors or random incomplete downloads without notification. Really frustrating :-( Good things are, building an OS a such a complex task that always there's something to do, and if something it's burning yourself you can try with another thing :-)

One recurrent issue people is having is that `nodeos-cross-toolchain` module [dissapears](https://github.com/NodeOS/NodeOS/issues/218) when using latest Node.js 5. The reason is that it includes npm 3, that has changed the organization of the `node_modules` folder to being maximally flat, deleting its folder on the way. Until now the only solution is to still use Node.js 4 and npm 2, but it will someday gets support and it's time to move on, so since it was almost autonomous I've finally converted it on an [independent npm module](https://github.com/NodeOS/nodeos-cross-toolchain) thanks to a modified version of the use of [prebuild](https://github.com/piranna/prebuild) to be able to use some [prebuild releases](https://github.com/NodeOS/nodeos-cross-toolchain/releases) of general purpose binaries. This allow to use `nodeos-cross-toolchain` as a dependency of the NodeOS layers without needing to build them again and again, but also move forward to the npm 3 support and more important to allow to test it independtly and reduce NodeOS build time to the half (yes, the cross-compiler takes so much time as NodeOS itself...), so now instead of [pick some microwave pop-corn and go to see a movie](https://github.com/NodeOS/NodeOS#build-nodeos-in-three-steps) it's just a matter of see one chapter of your favorite soap opera :-P It has helped to reduce build time not only to convert the cross-toolchain on a precompiled npm module, but also I've created prebuild modules for [genfatfs](https://github.com/NodeOS/genfatfs), [genext2fs](https://github.com/NodeOS/genext2fs) and [qemu](https://github.com/NodeOS/qemu). Yes, you've read it right: now you can use [QEmu](http://qemu.org) as a [npm dependency](https://github.com/NodeOS/NodeOS/blob/7cb4bb925986a97fb7ffd9e6fdf469b583cb56bd/package.json#L45), no kidding :-D

But to be honest, upcoming npm 3 support what not the main reason to move cross-toolchain as an independent module, but NodeOS prebuild images. NodeOS build process has got to be so much complex and heavy weight that the CI server was getting random errors constantly (and in fact I'm thinking to move to another one due to this, but I've not found any other free one as fast... maybe is it time to give another opportunity to TravisCI?), so the only possible solution was to split the build process in several independent fragments and test them separately, tha obvious first one was the cross-toolchain since it only would need changes when a new version of GCC or Linux kernel arises. So after adding the dependencies and tuning-up the build scripts and fix some bugs on the [publish-release](https://github.com/piranna/publish-release) module... finally we have [prebuild NodeOS images](https://github.com/NodeOS/NodeOS/releases) again after 4 months of silence, just ready so people can test the upcoming 1.0 version :-D

Last but not least, another tiny bit that has been floating around since some time ago was the possibility to add an [administrator mode](https://github.com/NodeOS/NodeOS/issues/177) that would allow to admin some system global configs like to allow to `logon` to [create new users](https://github.com/piranna/logon/issues/3), while at the same time don't allow users to log in the system to prevent problems like the fact in WIndows most people (specially in domestic environments) access to the system with administrator permissions. It was easier to implement that what I though on a first time, just by [forcing the user to a REPL](https://github.com/NodeOS/nodeos-mount-filesystems/blob/7937600616a6987d472d0e85d9c4143ec9585c97/server.js#L285) if system is booted with the `single` flag and don't execute the users `init` processes (specially the one for `root`, that start `logon`). This also help me to find a bug on [nodeos-init](https://github.com/piranna/nodeos-init) where it was trying to exec as a command any positional argument that it was being given so it though `single` was a command (when it's not :-) ), so now it [detects](https://github.com/piranna/nodeos-init/commit/c23ce46be2ada9e1899b9129a4a162507c43ff55) if the first one is an absolute path (since at boot the kernel doesn't define itself the `$PATH` environment variable used to locate the binaries) and if not, it gives all the parameters as arguments for the default `/sbin/init` binary that mount the partitions and boot the system :-)

So as you can see, steady NodeOS is moving towards it's 1.0 version! :-D Let's hope the issues that have appear on its dependencies modules can be fixed soon and we can release something we can be proud of :-)

